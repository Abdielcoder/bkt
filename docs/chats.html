<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="../assets/icons/favicon.ico" />
    <title>Tu Taxi - Chats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../css/docs/tadiDefaults.css" />
    <link rel="stylesheet" href="../css/docs/messages.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Sharp" rel="stylesheet" />
    <style>
      .chat-container {
        display: flex;
        height: calc(100vh - 200px);
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .chat-sidebar {
        width: 300px;
        background-color: #f8f9fa;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }

      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: white;
      }

      .chat-header {
        padding: 12px 16px;
        background: linear-gradient(90deg, #2d6e3d, #1f5330);
        color: white;
        border-bottom: 1px solid #1e472b;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .header-avatars {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .participant {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.6);
        background: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }
      .avatar img { width: 100%; height: 100%; object-fit: cover; }
      .header-info { display: flex; flex-direction: column; line-height: 1.1; }
      .header-title { font-size: 14px; color: white; opacity: 0.95; }
      .header-sub { font-size: 12px; color: white; opacity: 0.8; }

      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #f5f5f5;
      }
      .date-separator {
        text-align: center;
        margin: 16px 0;
        position: relative;
        color: #556;
        font-size: 12px;
      }
      .date-separator::before,
      .date-separator::after {
        content: "";
        position: absolute;
        top: 50%;
        width: 40%;
        height: 1px;
        background: #d0d0d0;
      }
      .date-separator::before { left: 0; }
      .date-separator::after { right: 0; }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
      }
      .message .avatar { width: 28px; height: 28px; border: none; margin: 0 6px; }

      .message.conductor {
        justify-content: flex-end;
      }

      .message.client {
        justify-content: flex-start;
      }

      .message-content {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
      }

      .message.conductor .message-content {
        background-color: #2d6e3d;
        color: white;
        border-bottom-right-radius: 5px;
      }

      .message.client .message-content {
        background-color: white;
        color: #333;
        border: 1px solid #ddd;
        border-bottom-left-radius: 5px;
      }

      .message-info {
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.7;
      }
      .message-text { white-space: pre-wrap; word-break: break-word; }
      .copied-toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(33, 33, 33, 0.92);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
        z-index: 9999;
        opacity: 0;
        transition: opacity .2s ease;
      }

      .trip-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .trip-item:hover {
        background-color: #e9ecef;
      }

      .trip-item.active {
        background-color: #2d6e3d;
        color: white;
      }
      .trip-item.active * {
        color: white !important;
      }

      .trip-id {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .trip-info {
        font-size: 12px;
        opacity: 0.8;
      }

      .search-container {
        padding: 15px;
        border-bottom: 1px solid #ddd;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
      }

      .no-messages {
        text-align: center;
        color: #666;
        margin-top: 50px;
        font-style: italic;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <div id="root" class="preload">
      <!-- Aside -->
      <aside>
        <div id="aside-container">
          <div class="logo">
            <a class="home-link" href="./main.html">Tu Taxi | Backoffice</a>
          </div>
          <hr />
          <ul class="nav">
            <li class="nav-item" id="mapa-menu-li" style="display: none">
              <a class="nav-link" href="./maps.html">
                <span class="link-icons material-icons-sharp">map</span>
                MAPA
              </a>
            </li>
            <li class="nav-item" id="concesionario-menu-li" style="display: none">
              <a class="nav-link hasSubmenu selectedPage" href="#" id="concesionario">
                <span class="link-icons material-icons-sharp">person</span>
                CONCESIONARIOS
              </a>
            </li>
            <li class="nav-item" id="vehiculos-menu-li">
              <a class="nav-link" href="./vehicles.html">
                <span class="link-icons material-icons-sharp">directions_car</span>
                VEHICULO
              </a>
            </li>
            <li class="nav-item" id="conductores-menu-li">
              <a class="nav-link" href="./users.html">
                <span class="link-icons material-icons-sharp">person</span>
                CONDUCTORES
              </a>
            </li>
            <li class="nav-item" id="chats-menu-li">
              <a class="nav-link active" href="./chats.html">
                <span class="link-icons material-icons-sharp">chat</span>
                CHATS
              </a>
            </li>
            <li class="nav-item menu-button menu-closed" id="historico-menu-li">
              <a class="nav-link" href="#" id="historico">
                <span class="link-icons material-icons-sharp">token</span>
                HISTORICO DE VIAJES
              </a>
              <div id="historico-submenu" data-displayed="hidden">
                <ul>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="./historico-conductores.html">
                      <span class="link-icons material-icons-sharp">person</span>
                      CONDUCTORES
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="./historico-clientes.html">
                      <span class="link-icons material-icons-sharp">person</span>
                      CLIENTES
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item menu-button menu-closed" id="admin-menu-li" style="display: none">
              <a class="nav-link" href="#" id="administracion">
                <span class="link-icons material-icons-sharp">manage_accounts</span>
                ADMINISTRACIÓN
              </a>
              <div id="administracion-submenu" data-displayed="hidden">
                <ul>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="../admin/mensajes/index.html">
                      <span class="link-icons material-icons-sharp">chat</span>
                      MENSAJES
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="../admin/administradores/index.html">
                      <span class="link-icons material-icons-sharp">person</span>
                      ADMINISTRADORES
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden" id="roles-menu-li">
                    <a class="nav-sublink" href="../admin/roles/index.html">
                      <span class="link-icons material-icons-sharp">groups</span>
                      ROLES
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="../admin/rates.html">
                      <span class="link-icons material-icons-sharp">paid</span>
                      TARIFAS
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="../admin/base_rates.html">
                      <span class="link-icons material-icons-sharp">attach_money</span>
                      TARIFAS BASE
                    </a>
                  </li>
                  <li class="nav-item menu-linked hidden">
                    <a class="nav-sublink" href="./accesos.html">
                      <span class="link-icons material-icons-sharp">history</span>
                      ACCESOS
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../admin/clientes/index.html">
                <span class="link-icons material-icons-sharp">person_pin</span>
                CLIENTES
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./seguridad-publica.html">
                <span class="link-icons material-icons-sharp">local_police</span>
                Seguridad Pública
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./mapa-seguridad.html">
                <span class="link-icons material-icons-sharp">local_police</span>
                Mapa Seguridad
              </a>
            </li>
          </ul>
        </div>
      </aside>

      <!-- Header  -->
      <header>
        <nav style="position: relative; z-index: 1;">
          <h1 class="app-title">Tu taxi - Portal Administrativo</h1>
          <button class="close-app" id="signout-button">
            <span class="material-icons-sharp">logout</span>
            Cerrar Sesión
          </button>
        </nav>
        <div class="header-bg-image" style="z-index: 0;"></div>
      </header>

      <!-- Main -->
      <main style="position: relative">
        <div class="page-title">
          <h2 class="header-module-title">Chats de Viajes</h2>
        </div>
        <div class="container">
          <div class="container-module col-12">
            <div class="module-body">
              <div class="chat-container">
                <!-- Sidebar con lista de viajes -->
                <div class="chat-sidebar">
                  <div class="search-container">
                    <input 
                      type="text" 
                      class="search-input" 
                      placeholder="Buscar viaje por ID..."
                      id="searchTripInput"
                    />
                  </div>
                  <div id="tripsList">
                    <div class="loading">Cargando viajes...</div>
                  </div>
                </div>

                <!-- Área principal de chat -->
                <div class="chat-main">
                  <div class="chat-header">
                    <div class="header-info">
                      <div class="header-title" id="chatTitle">Selecciona un viaje para ver los mensajes</div>
                      <div class="header-sub" id="chatSubtitle"></div>
                    </div>
                  </div>
                  <div class="chat-messages" id="chatMessages">
                    <div class="no-messages">
                      Selecciona un viaje del panel izquierdo para ver los mensajes del chat
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer>
        <p id="copyrightFooter"></p>
      </footer>
    </div>
  </body>
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-firestore.js"></script>
  <script type="module" src="../js/config/auth-config.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-storage.js"></script>
  <script src="../js/global-context.js"></script>
  <script src="../js/dom/mobile-menu.js"></script>
  <script type="module">
    const firestore = firebase.firestore();
    const rtdb = firebase.database();
    let tripsList = [];
    let selectedTripId = null;
    let unsubscribeTrip = null;
    let unsubscribeTrips = null;
    const avatarCache = {};

    // Función para formatear fecha
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('es-MX', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function formatDateOnly(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function getInitials(name = '') {
      const parts = name.trim().split(/\s+/);
      const initials = (parts[0]?.[0] || 'U') + (parts[1]?.[0] || '');
      return initials.toUpperCase();
    }

    function colorForId(id = '') {
      let hash = 0;
      for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 55%, 60%)`;
    }

    async function fetchAvatar(userId) {
      if (!userId) return null;
      if (avatarCache[userId]) return avatarCache[userId];
      try {
        // Intentar en Drivers
        const driverSnap = await rtdb.ref(`Users/Drivers/${userId}`).once('value');
        const driver = driverSnap.val();
        const driverPhoto = driver?.photoURL || driver?.profileImage || driver?.avatar;
        if (driverPhoto) { avatarCache[userId] = driverPhoto; return driverPhoto; }
      } catch (_) {}
      try {
        // Intentar en Clients
        const clientSnap = await rtdb.ref(`Users/Clients/${userId}`).once('value');
        const client = clientSnap.val();
        const clientPhoto = client?.photoURL || client?.profileImage || client?.avatar;
        if (clientPhoto) { avatarCache[userId] = clientPhoto; return clientPhoto; }
      } catch (_) {}
      avatarCache[userId] = null;
      return null;
    }

    // Función para cargar todos los viajes con chats
    async function loadTripsWithChats() {
      try {
        console.log("Cargando viajes con chats...");
        if (unsubscribeTrips) { unsubscribeTrips(); }
        unsubscribeTrips = firestore.collection('trip_chats').onSnapshot((tripsSnapshot) => {
          tripsList = [];
          tripsSnapshot.forEach(doc => {
            const data = doc.data();
            const messages = data.messages || [];
            const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
            const unreadCount = messages.filter(m => m && m.isRead === false).length;
            tripsList.push({
              id: doc.id,
              messageCount: data.messageCount || messages.length || 0,
              lastMessage,
              unreadCount
            });
          });
          // Ordenar por último mensaje descendente
          tripsList.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
          console.log(`Encontrados ${tripsList.length} viajes con chats`);
          renderTripsList();
        }, (error) => {
          console.error('Error snapshot trips:', error);
        });
        
      } catch (error) {
        console.error("Error al cargar viajes:", error);
        document.getElementById('tripsList').innerHTML = '<div class="loading">Error al cargar viajes</div>';
      }
    }

    // Función para renderizar la lista de viajes
    function renderTripsList() {
      const tripsListElement = document.getElementById('tripsList');
      
      if (tripsList.length === 0) {
        tripsListElement.innerHTML = '<div class="loading">No hay viajes con chats</div>';
        return;
      }

      tripsListElement.innerHTML = tripsList.map(trip => `
        <div class="trip-item" data-trip-id="${trip.id}" onclick="selectTrip('${trip.id}')">
          <div class="trip-id">Viaje: ${trip.id}</div>
          <div class="trip-info">
            Mensajes: ${trip.messageCount}${trip.unreadCount ? ` · <b>${trip.unreadCount} sin leer</b>` : ''}
            ${trip.lastMessage ? `<br>Último: ${formatDate(trip.lastMessage.timestamp)}` : ''}
          </div>
        </div>
      `).join('');
    }

    // Función para seleccionar un viaje
    async function selectTrip(tripId) {
      selectedTripId = tripId;
      
      // Actualizar UI
      document.querySelectorAll('.trip-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-trip-id="${tripId}"]`).classList.add('active');
      
      // Actualizar título
      document.getElementById('chatTitle').textContent = `Chat del Viaje: ${tripId}`;
      document.getElementById('chatSubtitle').textContent = '';
      
      // Cargar mensajes en tiempo real
      if (unsubscribeTrip) { unsubscribeTrip(); }
      unsubscribeTrip = firestore.collection('trip_chats').doc(tripId).onSnapshot(async (doc) => {
        if (!doc.exists) {
          document.getElementById('chatMessages').innerHTML = '<div class="no-messages">No se encontraron mensajes para este viaje</div>';
          return;
        }
        const data = doc.data();
        const messages = data.messages || [];
        renderMessages(messages);
      }, (error) => {
        console.error('Error snapshot trip:', error);
      });
    }

    // Función para cargar mensajes de un viaje específico
    async function loadTripMessages(tripId) {
      try {
        console.log(`Cargando mensajes para viaje: ${tripId}`);
        const tripDoc = await firestore.collection('trip_chats').doc(tripId).get();
        
        if (!tripDoc.exists) {
          document.getElementById('chatMessages').innerHTML = '<div class="no-messages">No se encontraron mensajes para este viaje</div>';
          return;
        }

        const tripData = tripDoc.data();
        const messages = tripData.messages || [];
        
        console.log(`Encontrados ${messages.length} mensajes`);
        renderMessages(messages);
        
      } catch (error) {
        console.error("Error al cargar mensajes:", error);
        document.getElementById('chatMessages').innerHTML = '<div class="no-messages">Error al cargar mensajes</div>';
      }
    }


    // Función para renderizar mensajes
    function renderMessages(messages) {
      const chatMessagesElement = document.getElementById('chatMessages');
      
      if (messages.length === 0) {
        chatMessagesElement.innerHTML = '<div class="no-messages">No hay mensajes en este chat</div>';
        return;
      }

      // Ordenar mensajes por timestamp
      messages.sort((a, b) => a.timestamp - b.timestamp);

      let lastDate = '';
      const parts = [];
      for (const message of messages) {
        const dateOnly = formatDateOnly(message.timestamp || Date.now());
        if (dateOnly !== lastDate) {
          parts.push(`<div class=\"date-separator\">${dateOnly}</div>`);
          lastDate = dateOnly;
        }
        const side = message.isConductor ? 'conductor' : 'client';
        const whoId = message.senderId || '';
        const whoName = message.senderName || (message.isConductor ? 'Conductor' : 'Cliente');
        const avatarHtml = (function(){
          const cached = avatarCache[whoId];
          if (cached) return `<div class=\"avatar\"><img src=\"${cached}\" alt=\"${whoName}\" /></div>`;
          return `<div class=\"avatar\" style=\"background:${colorForId(whoId || whoName)}\">${getInitials(whoName)}</div>`;
        })();
        parts.push(`
          <div class=\"message ${side}\">${side === 'client' ? avatarHtml : ''}
            <div class=\"message-content\">
              <div class=\"message-text\">${message.message}</div>
              <div class=\"message-info\">${whoName} · ${message.formattedTime || formatDate(message.timestamp)}${message.isRead ? ' ✓' : ''}</div>
            </div>
            ${side === 'conductor' ? avatarHtml : ''}
          </div>
        `);
      }
      chatMessagesElement.innerHTML = parts.join('');

      // Scroll al final
      chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;

      // Copiar al hacer clic sobre el texto
      chatMessagesElement.addEventListener('click', function(e){
        const target = e.target;
        if (target && target.classList.contains('message-text')) {
          const text = target.textContent || '';
          if (text) {
            navigator.clipboard?.writeText(text).then(() => showCopiedToast());
          }
        }
      }, { once: true });
    }

    function showCopiedToast() {
      const toast = document.createElement('div');
      toast.className = 'copied-toast';
      toast.textContent = 'Mensaje copiado';
      document.body.appendChild(toast);
      requestAnimationFrame(() => { toast.style.opacity = '1'; });
      setTimeout(() => { toast.style.opacity = '0'; toast.remove(); }, 1600);
    }

    // Función de búsqueda
    function setupSearch() {
      const searchInput = document.getElementById('searchTripInput');
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        
        if (searchTerm === '') {
          renderTripsList();
          return;
        }

        const filteredTrips = tripsList.filter(trip => 
          trip.id.toLowerCase().includes(searchTerm)
        );

        const tripsListElement = document.getElementById('tripsList');
        tripsListElement.innerHTML = filteredTrips.map(trip => `
          <div class="trip-item" data-trip-id="${trip.id}" onclick="selectTrip('${trip.id}')">
            <div class="trip-id">Viaje: ${trip.id}</div>
            <div class="trip-info">
              Mensajes: ${trip.messageCount}${trip.unreadCount ? ` · <b>${trip.unreadCount} sin leer</b>` : ''}
              ${trip.lastMessage ? `<br>Último: ${formatDate(trip.lastMessage.timestamp)}` : ''}
            </div>
          </div>
        `).join('');
      });
    }

    // Función principal
    async function main() {
      console.log("Iniciando aplicación de chats...");
      await loadTripsWithChats();
      setupSearch();
    }

    // Hacer funciones globales para onclick
    window.selectTrip = selectTrip;

    // Inicializar
    main();
  </script>
</html>
